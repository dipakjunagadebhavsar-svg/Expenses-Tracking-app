<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Company Financial Management</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #1f2937;
      --text: #e5e7eb;
      --subtext: #9ca3af;
      --primary: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
      --blue: #38bdf8;
      --border: #293246;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; border-bottom: 1px solid var(--border); background: rgba(17,24,39,0.9); position: sticky; top: 0; z-index: 50;
    }
    header h1 { font-size: 18px; margin: 0; letter-spacing: 0.5px; }
    nav { display: flex; gap: 8px; flex-wrap: wrap; }
    nav button {
      background: var(--muted); color: var(--text); border: 1px solid var(--border);
      padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600;
    }
    nav button.active { background: var(--blue); color: #062338; border-color: transparent; }
    main { padding: 16px; max-width: 1200px; margin: 0 auto; }
    .grid { display: grid; gap: 12px; }
    .grid.cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    .grid.cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .grid.cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .card {
      background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px;
    }
    .card h3 { margin: 0 0 8px 0; font-size: 16px; }
    .muted { color: var(--subtext); font-size: 12px; }
    .kpi { font-size: 22px; font-weight: 700; margin-top: 4px; }
    .row { display: flex; gap: 12px; align-items: center; }
    .grow { flex: 1; }
    label { display: block; font-size: 12px; color: var(--subtext); margin-bottom: 6px; }
    input, select, textarea {
      width: 100%; padding: 10px; background: #0b1220; border: 1px solid var(--border); color: var(--text); border-radius: 8px;
    }
    textarea { min-height: 80px; }
    .btn {
      display: inline-flex; gap: 8px; align-items: center; border: 1px solid var(--border);
      background: var(--muted); color: var(--text); padding: 10px 12px; border-radius: 8px; cursor: pointer; font-weight: 600;
    }
    .btn.primary { background: var(--primary); color: #062338; border-color: transparent; }
    .btn.warn { background: var(--warn); color: #231500; border-color: transparent; }
    .btn.danger { background: var(--danger); color: #2a0e10; border-color: transparent; }
    .btn.ghost { background: transparent; }
    .table {
      width: 100%; border-collapse: collapse; margin-top: 8px;
    }
    .table th, .table td {
      border-bottom: 1px solid var(--border); padding: 10px; text-align: left; font-size: 13px;
    }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .pill.income { background: rgba(34,197,94,0.2); color: #86efac; }
    .pill.expense { background: rgba(239,68,68,0.2); color: #fecaca; }
    .pill.unpaid { background: rgba(245,158,11,0.2); color: #fde68a; }
    .pill.paid { background: rgba(34,197,94,0.2); color: #86efac; }
    .right { text-align: right; }
    .center { text-align: center; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .section-actions { display: flex; gap: 8px; justify-content: flex-end; margin-bottom: 8px; }
    canvas { width: 100%; height: 240px; background: #0b1220; border: 1px solid var(--border); border-radius: 8px; }
    .footer { color: var(--subtext); font-size: 12px; margin-top: 16px; }
    .hidden { display: none !important; }
    @media (max-width: 900px) {
      .grid.cols-4, .grid.cols-3 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px) {
      .grid.cols-2, .grid.cols-3, .grid.cols-4 { grid-template-columns: 1fr; }
      nav { overflow-x: auto; padding-bottom: 8px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>FinManage — Company Financials</h1>
    <nav id="tabs"></nav>
  </header>

  <main>
    <!-- Dashboard -->
    <section id="dashboard" class="hidden">
      <div class="grid cols-4">
        <div class="card">
          <h3>Cash balance</h3>
          <div class="muted">Total income minus expenses</div>
          <div class="kpi" id="kpiBalance">₹0</div>
        </div>
        <div class="card">
          <h3>Monthly net</h3>
          <div class="muted">Income − Expenses (this month)</div>
          <div class="kpi" id="kpiMonthlyNet">₹0</div>
        </div>
        <div class="card">
          <h3>Unpaid invoices</h3>
          <div class="muted">Outstanding amount</div>
          <div class="kpi" id="kpiUnpaid">₹0</div>
        </div>
        <div class="card">
          <h3>Budget variance</h3>
          <div class="muted">This month</div>
          <div class="kpi" id="kpiVariance">₹0</div>
        </div>
      </div>

      <div class="grid cols-2" style="margin-top:12px;">
        <div class="card">
          <h3>Net trend</h3>
          <div class="muted">Last 12 months</div>
          <canvas id="chartNet"></canvas>
        </div>
        <div class="card">
          <h3>Category breakdown</h3>
          <div class="muted">This month expenses</div>
          <canvas id="chartPie"></canvas>
        </div>
      </div>
    </section>

    <!-- Transactions -->
    <section id="transactions" class="hidden">
      <div class="section-actions">
        <button class="btn primary" id="btnAddTxn">+ Add transaction</button>
        <button class="btn" id="btnImportTxn">Import JSON</button>
        <button class="btn" id="btnExportTxn">Export JSON</button>
      </div>
      <div class="card">
        <h3>New transaction</h3>
        <div class="grid cols-3">
          <div>
            <label>Type</label>
            <select id="txnType">
              <option value="income">Income</option>
              <option value="expense">Expense</option>
            </select>
          </div>
          <div>
            <label>Date</label>
            <input type="date" id="txnDate" />
          </div>
          <div>
            <label>Amount (₹)</label>
            <input type="number" id="txnAmount" step="0.01" placeholder="0.00" />
          </div>
        </div>
        <div class="grid cols-3" style="margin-top:8px;">
          <div>
            <label>Category</label>
            <input type="text" id="txnCategory" placeholder="e.g., Sales, Rent, Payroll" />
          </div>
          <div>
            <label>Account</label>
            <input type="text" id="txnAccount" placeholder="e.g., Bank, Cash" />
          </div>
          <div>
            <label>Notes</label>
            <input type="text" id="txnNotes" placeholder="Optional" />
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <button class="btn primary" id="btnSaveTxn">Save</button>
          <button class="btn ghost" id="btnClearTxn">Clear</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h3>Transactions</h3>
        <div class="row" style="margin-bottom:8px;">
          <input class="grow" id="txnSearch" placeholder="Search by category, notes, account..." />
          <select id="txnFilterType" style="max-width:200px;">
            <option value="all">All</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>
        </div>
        <table class="table" id="txnTable">
          <thead>
            <tr>
              <th>Date</th><th>Type</th><th>Category</th><th class="right">Amount (₹)</th><th>Account</th><th>Notes</th><th class="right">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="right"><strong>Income</strong></td>
              <td class="right" id="sumIncome">₹0</td>
              <td colspan="3"></td>
            </tr>
            <tr>
              <td colspan="3" class="right"><strong>Expenses</strong></td>
              <td class="right" id="sumExpense">₹0</td>
              <td colspan="3"></td>
            </tr>
            <tr>
              <td colspan="3" class="right"><strong>Net</strong></td>
              <td class="right" id="sumNet">₹0</td>
              <td colspan="3"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <!-- Invoices -->
    <section id="invoices" class="hidden">
      <div class="section-actions">
        <button class="btn primary" id="btnAddInv">+ Add invoice</button>
        <button class="btn" id="btnImportInv">Import JSON</button>
        <button class="btn" id="btnExportInv">Export JSON</button>
      </div>
      <div class="card">
        <h3>New invoice</h3>
        <div class="grid cols-3">
          <div>
            <label>Invoice #</label>
            <input type="text" id="invNumber" placeholder="INV-2025-001" />
          </div>
          <div>
            <label>Client</label>
            <input type="text" id="invClient" placeholder="Client name" />
          </div>
          <div>
            <label>Issue date</label>
            <input type="date" id="invDate" />
          </div>
        </div>
        <div class="grid cols-3" style="margin-top:8px;">
          <div>
            <label>Due date</label>
            <input type="date" id="invDue" />
          </div>
          <div>
            <label>Status</label>
            <select id="invStatus">
              <option value="unpaid">Unpaid</option>
              <option value="paid">Paid</option>
            </select>
          </div>
          <div>
            <label>Notes</label>
            <input type="text" id="invNotes" placeholder="Optional" />
          </div>
        </div>
        <div class="grid cols-3" style="margin-top:8px;">
          <div>
            <label>Subtotal (₹)</label>
            <input type="number" id="invSubtotal" step="0.01" placeholder="0.00" />
          </div>
          <div>
            <label>Tax (%)</label>
            <input type="number" id="invTaxPct" step="0.01" placeholder="18" />
          </div>
          <div>
            <label>Discount (₹)</label>
            <input type="number" id="invDiscount" step="0.01" placeholder="0.00" />
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <button class="btn primary" id="btnSaveInv">Save</button>
          <button class="btn ghost" id="btnClearInv">Clear</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h3>Invoices</h3>
        <div class="row" style="margin-bottom:8px;">
          <input class="grow" id="invSearch" placeholder="Search by client, number, notes..." />
          <select id="invFilterStatus" style="max-width:200px;">
            <option value="all">All</option>
            <option value="unpaid">Unpaid</option>
            <option value="paid">Paid</option>
          </select>
        </div>
        <table class="table" id="invTable">
          <thead>
            <tr>
              <th>#</th><th>Client</th><th>Issue</th><th>Due</th><th>Status</th><th class="right">Total (₹)</th><th class="right">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="5" class="right"><strong>Unpaid total</strong></td>
              <td class="right" id="sumUnpaid">₹0</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <!-- Budgets -->
    <section id="budgets" class="hidden">
      <div class="section-actions">
        <button class="btn primary" id="btnAddBudget">+ Add budget</button>
        <button class="btn" id="btnImportBudget">Import JSON</button>
        <button class="btn" id="btnExportBudget">Export JSON</button>
      </div>
      <div class="card">
        <h3>New budget line</h3>
        <div class="grid cols-3">
          <div>
            <label>Month</label>
            <input type="month" id="budMonth" />
          </div>
          <div>
            <label>Category</label>
            <input type="text" id="budCategory" placeholder="e.g., Rent, Marketing" />
          </div>
          <div>
            <label>Amount (₹)</label>
            <input type="number" id="budAmount" step="0.01" placeholder="0.00" />
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <button class="btn primary" id="btnSaveBudget">Save</button>
          <button class="btn ghost" id="btnClearBudget">Clear</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h3>Budgets</h3>
        <div class="row" style="margin-bottom:8px;">
          <input class="grow" id="budSearch" placeholder="Search by category, month..." />
        </div>
        <table class="table" id="budTable">
          <thead>
            <tr>
              <th>Month</th><th>Category</th><th class="right">Budget (₹)</th><th class="right">Actual (₹)</th><th class="right">Variance (₹)</th><th class="right">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Reports -->
    <section id="reports" class="hidden">
      <div class="card">
        <h3>Profit & Loss</h3>
        <div class="grid cols-3">
          <div>
            <label>Period start</label>
            <input type="date" id="plStart" />
          </div>
          <div>
            <label>Period end</label>
            <input type="date" id="plEnd" />
          </div>
          <div class="row" style="align-items:flex-end;">
            <button class="btn primary" id="btnGenPL">Generate</button>
            <button class="btn" id="btnExportPL">Export CSV</button>
          </div>
        </div>
        <table class="table" id="plTable" style="margin-top:8px;">
          <thead>
            <tr>
              <th>Category</th><th class="right">Income (₹)</th><th class="right">Expense (₹)</th><th class="right">Net (₹)</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td class="right"><strong>Total</strong></td>
              <td class="right" id="plTotalIncome">₹0</td>
              <td class="right" id="plTotalExpense">₹0</td>
              <td class="right" id="plTotalNet">₹0</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="card" style="margin-top:12px;">
        <h3>Cash flow summary</h3>
        <div class="grid cols-3">
          <div>
            <label>Period start</label>
            <input type="date" id="cfStart" />
          </div>
          <div>
            <label>Period end</label>
            <input type="date" id="cfEnd" />
          </div>
          <div class="row" style="align-items:flex-end;">
            <button class="btn primary" id="btnGenCF">Generate</button>
            <button class="btn" id="btnExportCF">Export CSV</button>
          </div>
        </div>
        <table class="table" id="cfTable" style="margin-top:8px;">
          <thead>
            <tr>
              <th>Month</th><th class="right">Income (₹)</th><th class="right">Expense (₹)</th><th class="right">Net (₹)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <div class="footer center">Local-only demo app. Back up via Export before clearing browser storage.</div>
  </main>

  <script>
    // ---------- Utilities ----------
    const formatINR = (n) => '₹' + (Number(n || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
    const todayStr = () => new Date().toISOString().slice(0,10);
    const monthKey = (d) => (d || todayStr()).slice(0,7); // YYYY-MM
    const clampNum = (v) => isFinite(+v) ? +v : 0;
    const uid = () => Math.random().toString(36).slice(2,9);

    const store = {
      get() {
        const raw = localStorage.getItem('finmanage');
        try { return raw ? JSON.parse(raw) : { txns: [], invs: [], buds: [] }; } catch { return { txns: [], invs: [], buds: [] }; }
      },
      set(data) { localStorage.setItem('finmanage', JSON.stringify(data)); }
    };

    const state = { ...store.get() };

    // ---------- Tabs ----------
    const sections = [
      { id: 'dashboard', label: 'Dashboard' },
      { id: 'transactions', label: 'Transactions' },
      { id: 'invoices', label: 'Invoices' },
      { id: 'budgets', label: 'Budgets' },
      { id: 'reports', label: 'Reports' },
    ];

    const tabsEl = document.getElementById('tabs');
    sections.forEach((s, i) => {
      const b = document.createElement('button');
      b.textContent = s.label;
      b.dataset.target = s.id;
      b.className = 'tab-btn';
      b.addEventListener('click', () => switchTab(s.id));
      tabsEl.appendChild(b);
    });

    function switchTab(id) {
      sections.forEach(s => {
        document.getElementById(s.id).classList.toggle('hidden', s.id !== id);
        const btn = [...tabsEl.children].find(b => b.dataset.target === s.id);
        btn.classList.toggle('active', s.id === id);
      });
      renderAll();
    }

    // default tab
    switchTab('dashboard');

    // ---------- Transactions ----------
    const txnType = document.getElementById('txnType');
    const txnDate = document.getElementById('txnDate');
    const txnAmount = document.getElementById('txnAmount');
    const txnCategory = document.getElementById('txnCategory');
    const txnAccount = document.getElementById('txnAccount');
    const txnNotes = document.getElementById('txnNotes');
    const txnTableBody = document.querySelector('#txnTable tbody');
    const sumIncomeEl = document.getElementById('sumIncome');
    const sumExpenseEl = document.getElementById('sumExpense');
    const sumNetEl = document.getElementById('sumNet');
    const txnSearch = document.getElementById('txnSearch');
    const txnFilterType = document.getElementById('txnFilterType');

    txnDate.value = todayStr();

    document.getElementById('btnSaveTxn').addEventListener('click', () => {
      const item = {
        id: uid(),
        type: txnType.value,
        date: txnDate.value || todayStr(),
        amount: clampNum(txnAmount.value),
        category: txnCategory.value.trim() || (txnType.value === 'income' ? 'Sales' : 'Misc'),
        account: txnAccount.value.trim() || 'Bank',
        notes: txnNotes.value.trim()
      };
      if (!item.amount || item.amount <= 0) return alert('Enter a valid amount.');
      state.txns.push(item);
      store.set(state);
      clearTxnForm();
      renderTxns();
      renderKPIs();
      renderCharts();
      syncBudgetsActuals();
    });

    document.getElementById('btnClearTxn').addEventListener('click', clearTxnForm);
    function clearTxnForm() {
      txnType.value = 'income';
      txnDate.value = todayStr();
      txnAmount.value = '';
      txnCategory.value = '';
      txnAccount.value = '';
      txnNotes.value = '';
    }

    document.getElementById('btnExportTxn').addEventListener('click', () => downloadJSON('transactions.json', state.txns));
    document.getElementById('btnImportTxn').addEventListener('click', () => importJSON(list => { state.txns = list; store.set(state); renderAll(); }));

    txnSearch.addEventListener('input', renderTxns);
    txnFilterType.addEventListener('change', renderTxns);

    function renderTxns() {
      const q = txnSearch.value.toLowerCase();
      const fType = txnFilterType.value;
      const rows = state.txns
        .filter(t =>
          (fType === 'all' || t.type === fType) &&
          (t.category.toLowerCase().includes(q) || (t.notes || '').toLowerCase().includes(q) || (t.account || '').toLowerCase().includes(q))
        )
        .sort((a,b) => a.date.localeCompare(b.date));

      txnTableBody.innerHTML = rows.map(t => `
        <tr>
          <td>${t.date}</td>
          <td><span class="pill ${t.type}">${t.type}</span></td>
          <td>${t.category}</td>
          <td class="right">${formatINR(t.amount)}</td>
          <td>${t.account || ''}</td>
          <td>${t.notes || ''}</td>
          <td class="right actions">
            <button class="btn" onclick="editTxn('${t.id}')">Edit</button>
            <button class="btn danger" onclick="deleteTxn('${t.id}')">Delete</button>
          </td>
        </tr>
      `).join('');

      const income = state.txns.filter(t => t.type === 'income').reduce((s,t)=>s+t.amount,0);
      const expense = state.txns.filter(t => t.type === 'expense').reduce((s,t)=>s+t.amount,0);
      sumIncomeEl.textContent = formatINR(income);
      sumExpenseEl.textContent = formatINR(expense);
      sumNetEl.textContent = formatINR(income - expense);
    }

    window.editTxn = (id) => {
      const t = state.txns.find(x => x.id === id);
      if (!t) return;
      txnType.value = t.type;
      txnDate.value = t.date;
      txnAmount.value = t.amount;
      txnCategory.value = t.category;
      txnAccount.value = t.account || '';
      txnNotes.value = t.notes || '';
      // Replace Save behavior temporarily
      const saveBtn = document.getElementById('btnSaveTxn');
      const origHandler = saveBtn.onclick;
      saveBtn.textContent = 'Update';
      saveBtn.onclick = () => {
        t.type = txnType.value;
        t.date = txnDate.value || t.date;
        t.amount = clampNum(txnAmount.value);
        t.category = txnCategory.value.trim() || t.category;
        t.account = txnAccount.value.trim();
        t.notes = txnNotes.value.trim();
        store.set(state);
        saveBtn.textContent = 'Save';
        saveBtn.onclick = origHandler || null;
        clearTxnForm();
        renderTxns();
        renderKPIs();
        renderCharts();
        syncBudgetsActuals();
      };
    };

    window.deleteTxn = (id) => {
      if (!confirm('Delete this transaction?')) return;
      state.txns = state.txns.filter(t => t.id !== id);
      store.set(state);
      renderTxns();
      renderKPIs();
      renderCharts();
      syncBudgetsActuals();
    };

    // ---------- Invoices ----------
    const invNumber = document.getElementById('invNumber');
    const invClient = document.getElementById('invClient');
    const invDate = document.getElementById('invDate');
    const invDue = document.getElementById('invDue');
    const invStatus = document.getElementById('invStatus');
    const invNotes = document.getElementById('invNotes');
    const invSubtotal = document.getElementById('invSubtotal');
    const invTaxPct = document.getElementById('invTaxPct');
    const invDiscount = document.getElementById('invDiscount');
    const invTableBody = document.querySelector('#invTable tbody');
    const invSearch = document.getElementById('invSearch');
    const invFilterStatus = document.getElementById('invFilterStatus');
    const sumUnpaidEl = document.getElementById('sumUnpaid');

    invDate.value = todayStr();

    document.getElementById('btnSaveInv').addEventListener('click', () => {
      const subtotal = clampNum(invSubtotal.value);
      const taxPct = clampNum(invTaxPct.value);
      const discount = clampNum(invDiscount.value);
      const tax = subtotal * (taxPct/100);
      const total = Math.max(0, subtotal + tax - discount);

      const item = {
        id: uid(),
        number: invNumber.value.trim() || ('INV-' + new Date().getTime()),
        client: invClient.value.trim() || 'Client',
        issueDate: invDate.value || todayStr(),
        dueDate: invDue.value || invDate.value || todayStr(),
        status: invStatus.value,
        notes: invNotes.value.trim(),
        subtotal, taxPct, discount, total
      };
      if (!subtotal || subtotal <= 0) return alert('Enter a valid subtotal.');
      state.invs.push(item);
      store.set(state);
      clearInvForm();
      renderInvs();
      renderKPIs();
    });

    document.getElementById('btnClearInv').addEventListener('click', clearInvForm);
    function clearInvForm() {
      invNumber.value = '';
      invClient.value = '';
      invDate.value = todayStr();
      invDue.value = '';
      invStatus.value = 'unpaid';
      invNotes.value = '';
      invSubtotal.value = '';
      invTaxPct.value = '18';
      invDiscount.value = '';
    }

    document.getElementById('btnExportInv').addEventListener('click', () => downloadJSON('invoices.json', state.invs));
    document.getElementById('btnImportInv').addEventListener('click', () => importJSON(list => { state.invs = list; store.set(state); renderAll(); }));

    invSearch.addEventListener('input', renderInvs);
    invFilterStatus.addEventListener('change', renderInvs);

    function renderInvs() {
      const q = invSearch.value.toLowerCase();
      const f = invFilterStatus.value;
      const rows = state.invs
        .filter(i=> (f==='all' || i.status===f) && (i.client.toLowerCase().includes(q) || i.number.toLowerCase().includes(q) || (i.notes||'').toLowerCase().includes(q)))
        .sort((a,b)=> a.issueDate.localeCompare(b.issueDate));

      invTableBody.innerHTML = rows.map(i => `
        <tr>
          <td>${i.number}</td>
          <td>${i.client}</td>
          <td>${i.issueDate}</td>
          <td>${i.dueDate}</td>
          <td><span class="pill ${i.status}">${i.status}</span></td>
          <td class="right">${formatINR(i.total)}</td>
          <td class="right actions">
            <button class="btn" onclick="editInv('${i.id}')">Edit</button>
            <button class="btn warn" onclick="togglePaid('${i.id}')">${i.status==='paid'?'Mark unpaid':'Mark paid'}</button>
            <button class="btn danger" onclick="deleteInv('${i.id}')">Delete</button>
          </td>
        </tr>
      `).join('');

      const unpaidTotal = state.invs.filter(i=>i.status==='unpaid').reduce((s,i)=>s+i.total,0);
      sumUnpaidEl.textContent = formatINR(unpaidTotal);
    }

    window.editInv = (id) => {
      const i = state.invs.find(x=>x.id===id);
      if (!i) return;
      invNumber.value = i.number;
      invClient.value = i.client;
      invDate.value = i.issueDate;
      invDue.value = i.dueDate;
      invStatus.value = i.status;
      invNotes.value = i.notes || '';
      invSubtotal.value = i.subtotal;
      invTaxPct.value = i.taxPct;
      invDiscount.value = i.discount;

      const saveBtn = document.getElementById('btnSaveInv');
      const orig = saveBtn.onclick;
      saveBtn.textContent = 'Update';
      saveBtn.onclick = () => {
        i.number = invNumber.value.trim() || i.number;
        i.client = invClient.value.trim() || i.client;
        i.issueDate = invDate.value || i.issueDate;
        i.dueDate = invDue.value || i.dueDate;
        i.status = invStatus.value;
        i.notes = invNotes.value.trim();
        i.subtotal = clampNum(invSubtotal.value);
        i.taxPct = clampNum(invTaxPct.value);
        i.discount = clampNum(invDiscount.value);
        i.total = Math.max(0, i.subtotal + i.subtotal*(i.taxPct/100) - i.discount);
        store.set(state);
        saveBtn.textContent = 'Save';
        saveBtn.onclick = orig || null;
        clearInvForm();
        renderInvs();
        renderKPIs();
      };
    };

    window.togglePaid = (id) => {
      const i = state.invs.find(x=>x.id===id);
      if (!i) return;
      i.status = (i.status==='paid') ? 'unpaid' : 'paid';
      store.set(state);
      renderInvs();
      renderKPIs();
    };

    window.deleteInv = (id) => {
      if (!confirm('Delete this invoice?')) return;
      state.invs = state.invs.filter(i=>i.id!==id);
      store.set(state);
      renderInvs();
      renderKPIs();
    };

    // ---------- Budgets ----------
    const budMonth = document.getElementById('budMonth');
    const budCategory = document.getElementById('budCategory');
    const budAmount = document.getElementById('budAmount');
    const budTableBody = document.querySelector('#budTable tbody');
    const budSearch = document.getElementById('budSearch');

    budMonth.value = monthKey();

    document.getElementById('btnSaveBudget').addEventListener('click', () => {
      const item = {
        id: uid(),
        month: budMonth.value || monthKey(),
        category: budCategory.value.trim() || 'Misc',
        amount: clampNum(budAmount.value),
        actual: 0
      };
      if (!item.amount || item.amount <= 0) return alert('Enter a valid budget amount.');
      state.buds.push(item);
      store.set(state);
      clearBudgetForm();
      syncBudgetsActuals();
      renderBudgets();
      renderKPIs();
    });

    document.getElementById('btnClearBudget').addEventListener('click', clearBudgetForm);
    function clearBudgetForm() {
      budMonth.value = monthKey();
      budCategory.value = '';
      budAmount.value = '';
    }

    document.getElementById('btnExportBudget').addEventListener('click', () => downloadJSON('budgets.json', state.buds));
    document.getElementById('btnImportBudget').addEventListener('click', () => importJSON(list => { state.buds = list; store.set(state); renderAll(); }));

    budSearch.addEventListener('input', renderBudgets);

    function syncBudgetsActuals() {
      // Compute actuals per month/category from expenses
      const map = {};
      for (const t of state.txns.filter(x=>x.type==='expense')) {
        const mk = monthKey(t.date);
        const key = mk + '|' + (t.category || 'Misc');
        map[key] = (map[key] || 0) + t.amount;
      }
      for (const b of state.buds) {
        const k = b.month + '|' + b.category;
        b.actual = clampNum(map[k] || 0);
      }
      store.set(state);
    }

    function renderBudgets() {
      const q = budSearch.value.toLowerCase();
      const rows = state.buds
        .filter(b=> (b.category.toLowerCase().includes(q) || b.month.toLowerCase().includes(q)))
        .sort((a,b)=> a.month.localeCompare(b.month) || a.category.localeCompare(b.category));

      budTableBody.innerHTML = rows.map(b => {
        const variance = b.amount - b.actual;
        const color = variance >= 0 ? 'income' : 'expense';
        return `
          <tr>
            <td>${b.month}</td>
            <td>${b.category}</td>
            <td class="right">${formatINR(b.amount)}</td>
            <td class="right">${formatINR(b.actual)}</td>
            <td class="right"><span class="pill ${color}">${formatINR(variance)}</span></td>
            <td class="right actions">
              <button class="btn" onclick="editBudget('${b.id}')">Edit</button>
              <button class="btn danger" onclick="deleteBudget('${b.id}')">Delete</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    window.editBudget = (id) => {
      const b = state.buds.find(x=>x.id===id);
      if (!b) return;
      budMonth.value = b.month;
      budCategory.value = b.category;
      budAmount.value = b.amount;
      const saveBtn = document.getElementById('btnSaveBudget');
      const orig = saveBtn.onclick;
      saveBtn.textContent = 'Update';
      saveBtn.onclick = () => {
        b.month = budMonth.value || b.month;
        b.category = budCategory.value.trim() || b.category;
        b.amount = clampNum(budAmount.value);
        store.set(state);
        syncBudgetsActuals();
        saveBtn.textContent = 'Save';
        saveBtn.onclick = orig || null;
        clearBudgetForm();
        renderBudgets();
        renderKPIs();
      };
    };

    window.deleteBudget = (id) => {
      if (!confirm('Delete this budget line?')) return;
      state.buds = state.buds.filter(b=>b.id!==id);
      store.set(state);
      renderBudgets();
      renderKPIs();
    };

    // ---------- Reports ----------
    const plStart = document.getElementById('plStart');
    const plEnd = document.getElementById('plEnd');
    const plTableBody = document.querySelector('#plTable tbody');
    const plTotalIncome = document.getElementById('plTotalIncome');
    const plTotalExpense = document.getElementById('plTotalExpense');
    const plTotalNet = document.getElementById('plTotalNet');

    const cfStart = document.getElementById('cfStart');
    const cfEnd = document.getElementById('cfEnd');
    const cfTableBody = document.querySelector('#cfTable tbody');

    plStart.value = new Date(new Date().getFullYear(), 0, 1).toISOString().slice(0,10);
    plEnd.value = todayStr();
    cfStart.value = plStart.value;
    cfEnd.value = plEnd.value;

    document.getElementById('btnGenPL').addEventListener('click', renderPL);
    document.getElementById('btnExportPL').addEventListener('click', () => exportTableCSV('profit_loss.csv', '#plTable'));

    document.getElementById('btnGenCF').addEventListener('click', renderCF);
    document.getElementById('btnExportCF').addEventListener('click', () => exportTableCSV('cash_flow.csv', '#cfTable'));

    function renderPL() {
      const start = plStart.value || '0001-01-01';
      const end = plEnd.value || '9999-12-31';
      const byCat = {};
      for (const t of state.txns.filter(x=>x.date >= start && x.date <= end)) {
        const cat = t.category || (t.type==='income'?'Sales':'Misc');
        byCat[cat] = byCat[cat] || { income: 0, expense: 0 };
        byCat[cat][t.type] += t.amount;
      }
      const rows = Object.entries(byCat).map(([cat, v]) => ({ cat, income: v.income, expense: v.expense, net: v.income - v.expense }))
        .sort((a,b)=> a.cat.localeCompare(b.cat));

      plTableBody.innerHTML = rows.map(r => `
        <tr>
          <td>${r.cat}</td>
          <td class="right">${formatINR(r.income)}</td>
          <td class="right">${formatINR(r.expense)}</td>
          <td class="right">${formatINR(r.net)}</td>
        </tr>
      `).join('');

      const ti = rows.reduce((s,r)=>s+r.income,0);
      const te = rows.reduce((s,r)=>s+r.expense,0);
      plTotalIncome.textContent = formatINR(ti);
      plTotalExpense.textContent = formatINR(te);
      plTotalNet.textContent = formatINR(ti - te);
    }

    function renderCF() {
      const start = cfStart.value || '0001-01-01';
      const end = cfEnd.value || '9999-12-31';
      const byMonth = {};
      for (const t of state.txns.filter(x=>x.date >= start && x.date <= end)) {
        const mk = monthKey(t.date);
        byMonth[mk] = byMonth[mk] || { income: 0, expense: 0 };
        byMonth[mk][t.type] += t.amount;
      }
      const months = Object.keys(byMonth).sort();
      cfTableBody.innerHTML = months.map(m => {
        const v = byMonth[m]; const net = v.income - v.expense;
        return `
          <tr>
            <td>${m}</td>
            <td class="right">${formatINR(v.income)}</td>
            <td class="right">${formatINR(v.expense)}</td>
            <td class="right">${formatINR(net)}</td>
          </tr>
        `;
      }).join('');
    }

    // ---------- Dashboard KPIs & Charts ----------
    const kpiBalance = document.getElementById('kpiBalance');
    const kpiMonthlyNet = document.getElementById('kpiMonthlyNet');
    const kpiUnpaid = document.getElementById('kpiUnpaid');
    const kpiVariance = document.getElementById('kpiVariance');

    function renderKPIs() {
      const income = state.txns.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
      const expense = state.txns.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
      kpiBalance.textContent = formatINR(income - expense);

      const mk = monthKey();
      const mi = state.txns.filter(t=>t.type==='income' && monthKey(t.date)===mk).reduce((s,t)=>s+t.amount,0);
      const me = state.txns.filter(t=>t.type==='expense' && monthKey(t.date)===mk).reduce((s,t)=>s+t.amount,0);
      kpiMonthlyNet.textContent = formatINR(mi - me);

      const unpaid = state.invs.filter(i=>i.status==='unpaid').reduce((s,i)=>s+i.total,0);
      kpiUnpaid.textContent = formatINR(unpaid);

      // Budget variance this month: sum(budget) - sum(actual)
      const buds = state.buds.filter(b=>b.month===mk);
      const bsum = buds.reduce((s,b)=>s+b.amount,0);
      const asum = buds.reduce((s,b)=>s+b.actual,0);
      kpiVariance.textContent = formatINR(bsum - asum);
    }

    function renderCharts() {
      netChart();
      pieChart();
    }

    function netChart() {
      const el = document.getElementById('chartNet');
      const ctx = el.getContext('2d');
      ctx.clearRect(0,0,el.width,el.height);
      const months = getLast12Months();
      const values = months.map(m => {
        const inc = state.txns.filter(t=>t.type==='income' && monthKey(t.date)===m).reduce((s,t)=>s+t.amount,0);
        const exp = state.txns.filter(t=>t.type==='expense' && monthKey(t.date)===m).reduce((s,t)=>s+t.amount,0);
        return inc - exp;
      });
      drawLineChart(ctx, months, values, { color: '#22c55e' });
    }

    function pieChart() {
      const el = document.getElementById('chartPie');
      const ctx = el.getContext('2d');
      ctx.clearRect(0,0,el.width,el.height);
      const mk = monthKey();
      const map = {};
      for (const t of state.txns.filter(x=>x.type==='expense' && monthKey(x.date)===mk)) {
        const cat = t.category || 'Misc';
        map[cat] = (map[cat] || 0) + t.amount;
      }
      const labels = Object.keys(map);
      const values = Object.values(map);
      drawPieChart(ctx, labels, values);
    }

    function getLast12Months() {
      const d = new Date();
      const out = [];
      for (let i=11; i>=0; i--) {
        const x = new Date(d.getFullYear(), d.getMonth()-i, 1);
        out.push(x.toISOString().slice(0,7));
      }
      return out;
    }

    function drawLineChart(ctx, labels, values, { color = '#38bdf8' } = {}) {
      const w = ctx.canvas.width, h = ctx.canvas.height;
      const pad = 30;
      const min = Math.min(...values, 0);
      const max = Math.max(...values, 0);
      const scaleY = (v) => {
        if (max === min) return h/2;
        return h - pad - ((v - min) / (max - min)) * (h - pad*2);
      };
      const stepX = (w - pad*2) / Math.max(1, labels.length - 1);
      // axes
      ctx.strokeStyle = '#334155';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(pad, pad);
      ctx.lineTo(pad, h - pad);
      ctx.lineTo(w - pad, h - pad);
      ctx.stroke();
      // zero line
      const y0 = scaleY(0);
      ctx.strokeStyle = '#475569';
      ctx.setLineDash([4,4]);
      ctx.beginPath();
      ctx.moveTo(pad, y0);
      ctx.lineTo(w - pad, y0);
      ctx.stroke();
      ctx.setLineDash([]);

      // line
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      values.forEach((v, i) => {
        const x = pad + i * stepX;
        const y = scaleY(v);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();

      // points
      ctx.fillStyle = color;
      values.forEach((v, i) => {
        const x = pad + i * stepX;
        const y = scaleY(v);
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, Math.PI*2);
        ctx.fill();
      });

      // labels (x)
      ctx.fillStyle = '#94a3b8';
      ctx.font = '12px system-ui';
      labels.forEach((lab, i) => {
        const x = pad + i * stepX;
        ctx.fillText(lab, x-14, h - pad + 14);
      });
    }

    function drawPieChart(ctx, labels, values) {
      const w = ctx.canvas.width, h = ctx.canvas.height;
      const cx = w/2, cy = h/2, r = Math.min(w, h)/2 - 20;
      const sum = values.reduce((s,v)=>s+v,0);
      const colors = ['#22c55e','#38bdf8','#f59e0b','#ef4444','#a78bfa','#14b8a6','#fb7185'];
      let start = -Math.PI/2;
      values.forEach((v, i) => {
        const angle = sum ? (v/sum) * Math.PI*2 : 0;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, r, start, start + angle);
        ctx.fillStyle = colors[i % colors.length];
        ctx.fill();
        start += angle;
      });
      // legend
      ctx.fillStyle = '#94a3b8';
      ctx.font = '12px system-ui';
      labels.forEach((lab, i) => {
        const y = 16 + i*16;
        ctx.fillStyle = colors[i % colors.length];
        ctx.fillRect(8, y-8, 10, 10);
        ctx.fillStyle = '#94a3b8';
        const pct = sum ? ((values[i]/sum)*100).toFixed(0) : 0;
        ctx.fillText(`${lab} ${pct}%`, 24, y);
      });
    }

    // ---------- Export / Import ----------
    function downloadJSON(filename, data) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    function importJSON(callback) {
      const input = document.createElement('input');
      input.type = 'file'; input.accept = 'application/json';
      input.onchange = () => {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const json = JSON.parse(reader.result);
            callback(Array.isArray(json) ? json : []);
          } catch (e) { alert('Invalid JSON file.'); }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    function exportTableCSV(filename, selector) {
      const table = document.querySelector(selector);
      const rows = [...table.querySelectorAll('tr')].map(tr => 
        [...tr.children].map(td => td.textContent.replace(/\s+/g,' ').trim())
      );
      const csv = rows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    // ---------- Initial render ----------
    function renderAll() {
      syncBudgetsActuals();
      renderKPIs();
      renderTxns();
      renderInvs();
      renderBudgets();
      renderCharts();
    }
    renderAll();

    // ---------- Keyboard shortcuts ----------
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key.toLowerCase() === 'b') switchTab('dashboard');
      if (e.ctrlKey && e.key.toLowerCase() === 't') switchTab('transactions');
      if (e.ctrlKey && e.key.toLowerCase() === 'i') switchTab('invoices');
      if (e.ctrlKey && e.key.toLowerCase() === 'u') switchTab('budgets');
      if (e.ctrlKey && e.key.toLowerCase() === 'r') switchTab('reports');
    });
  </script>
</body>
</html>
